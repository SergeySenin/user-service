# User Service

Сервис управления пользователями на Spring Boot 3.5 и Java 17.
Приложение использует PostgreSQL, Redis, S3-совместимое хранилище и интеграции по REST.
Ниже собраны инструкции по запуску, настройке профилей и тестированию.

## Содержание
- [Быстрый старт](#быстрый-старт)
  - [Локальная разработка (`local`)](#локальная-разработка-local)
  - [Контейнер для `prod`](#контейнер-для-prod)
- [Профили конфигурации](#профили-конфигурации)
- [Переменные окружения `prod`](#переменные-окружения-prod)
- [Офлайн-прогрев](#офлайн-прогрев)
- [Тестирование](#тестирование)
- [OpenAPI и Swagger UI](#openapi-и-swagger-ui)
- [Полезные файлы](#полезные-файлы)

## Быстрый старт

### Локальная разработка (`local`)
1. Установите Docker и Docker Compose v2.
2. Выполните `docker compose up -d` в корне репозитория — поднимутся
   PostgreSQL, Redis и MinIO с зафиксированными образами,
   healthcheck’ами и предварительно созданным бакетом `corpbucket`.
3. Запустите приложение командой `./gradlew bootRun`.
   Профиль `local` активируется автоматически.
4. Проверяйте здоровье сервиса по адресу `http://localhost:8080/api/v1/actuator/health`.
   Консоль MinIO доступна на `http://localhost:9001` (логин/пароль `local/localpassword`).

Параметры локального окружения заданы в `src/main/resources/application-local.yaml`,
инфраструктура описана в `docker-compose.yml`.

### Контейнер для `prod`
1. Соберите образ: `docker build -t user-service .`. 
   Мультистейдж-сборка упакует `bootJar`, настроит JRE-слой и добавит healthcheck.
2. Запустите контейнер, передав переменные окружения из раздела
   [«Переменные окружения `prod`»](#переменные-окружения-prod) и пробросив
   порт `8080`, например: `docker run -p 8080:8080 --env-file .env user-service`.
3. Healthcheck внутри образа обращается к `/api/v1/actuator/health/readiness`,
   поэтому его же следует мониторить в оркестраторе.

Профиль `prod` активируется по умолчанию,
параметры JVM задаются через `JAVA_TOOL_OPTIONS` в `Dockerfile`.

## Профили конфигурации

| Профиль | Назначение                                | Источник данных                                                               | Liquibase                                                          | Redis                                          | Особенности                                                          |
|---------|-------------------------------------------|-------------------------------------------------------------------------------|--------------------------------------------------------------------|------------------------------------------------|----------------------------------------------------------------------|
| `local` | Локальная разработка через docker-compose | `jdbc:postgresql://localhost:5432/user_service`, пользователь `user/password` | Отключён                                                           | `localhost:6379`                               | MinIO и внешние клиенты работают на локальные заглушки               |
| `prod`  | Боевое окружение                          | Переменные `DB_URL`, `DB_USER`, `DB_PASSWORD`                                 | Включён, ожидает `classpath:db/changelog/db.changelog-master.yaml` | Настраивается через `REDIS_HOST`, `REDIS_PORT` | Обязательные параметры клиентов и S3 берутся из переменных окружения |
| `test`  | Интеграционные тесты (Testcontainers)     | JDBC-URL подменяется контейнером PostgreSQL                                   | Отключён                                                           | Автоконфигурация Redis исключена               | Баннер выключен, логирование снижено                                 |

## Переменные окружения `prod`

| Категория       | Переменные                                                                        | Назначение                                                 |
|-----------------|-----------------------------------------------------------------------------------|------------------------------------------------------------|
| База данных     | `DB_URL`, `DB_USER`, `DB_PASSWORD`                                                | JDBC-строка подключения и учётные данные                   |
| Redis           | `REDIS_HOST`, `REDIS_PORT` (опционально)                                          | Хост и порт кеша, по умолчанию `redis:6379`                |
| S3              | `S3_ENDPOINT`, `S3_ACCESS_KEY`, `S3_SECRET_KEY`, `S3_BUCKET`, `S3_URL_EXPIRATION` | Настройка S3-совместимого хранилища и TTL presigned-ссылок |
| Внешние сервисы | `PROJECT_SVC_URL`, `PAYMENT_SVC_URL`                                              | Базовые URL интеграций                                     |

Все переменные заданы в `src/main/resources/application-prod.yaml`:
обязательные отмечены оператором `:?`, остальные имеют дефолты.
Перед запуском убедитесь, что changelog Liquibase находится
по пути `classpath:db/changelog/db.changelog-master.yaml`.
Осознанно подключаем чистый SQL-файл без `--liquibase formatted sql`
и отдельных changeset’ов — для проекта не требуется отслеживание миграций и откатов средствами Liquibase.

## Офлайн-прогрев

Скрипт `./install.sh` готовит окружение для работы без доступа к интернету:
- проверяет наличие Docker и Java, выводит их версии;
- подготавливает Gradle Wrapper и прогревает зависимости
  (включая Testcontainers) через сборку с тестами;
- скачивает заранее pinned Docker-образы PostgreSQL, Redis, MinIO и Temurin JDK/JRE.

После выполнения скрипта можно запускать Gradle
с флагом `--offline` и использовать локальные образы.

## Тестирование
- Интеграционный smoke-тест `DatabaseSmokeIT` поднимает PostgreSQL 16.3
в Testcontainers и выполняет `select 1`, проверяя корректность `DataSource`.
- Gradle настроен на запуск тестов в профиле `test` с подробными логами стандартных потоков.

Команда запуска: `./gradlew test`. При необходимости предварительно выполните офлайн-прогрев.

## OpenAPI и Swagger UI
Благодаря зависимости `springdoc-openapi-starter-webmvc-ui` после запуска сервиса
Swagger UI доступен по адресу `http://localhost:8080/api/v1/swagger-ui.html`.
Используйте его для изучения и ручного тестирования REST-эндпоинтов.

## Полезные файлы
- `docker-compose.yml` — описание локального стенда с зафиксированными образами и healthcheck’ами.
- `Dockerfile` — мультистейджовая сборка контейнера с настройкой профиля `prod` и JVM.
- `install.sh` — сценарий офлайн-прогрева Gradle и Docker.
- `src/main/resources/application-*.yaml` — параметры профилей `local`, `prod` и `test`.
- `gradle/verification-metadata.xml` — контрольные суммы зависимостей для проверки целостности.

## Проверка зависимостей Gradle

В проекте включена строгая проверка зависимостей Gradle (`verification-metadata.xml`).
Каждая сборка сверяет контрольные суммы артефактов из
конфигураций `compileClasspath`и `runtimeClasspath`, поэтому
любые изменения дерева зависимостей требуют обновления metadata.

### Как обновлять metadata

1. Внесите необходимые изменения в `build.gradle.kts` или `settings.gradle.kts`
   (добавление/удаление зависимостей, изменение версий, глобальные `exclude`).
2. Выполните команду:
   ```bash
   ./gradlew --write-verification-metadata sha256 \
             --configurations compileClasspath runtimeClasspath
   ```
   Gradle пересоберёт `gradle/verification-metadata.xml`,
   добавив контрольные суммы новых артефактов.
3. Проверьте, что файл обновился автоматически, и 
   закоммитьте его вместе с правками зависимостей.

### Ограничения

- Не используйте динамические версии (`+`, `latest.release` и т.п.)
  — они ломают воспроизводимость и влекут ошибки верификации.
- Старайтесь ограничивать `exclude` только нужными конфигурациями,
  чтобы не вызывать массовых обновлений metadata.
- Не редактируйте `verification-metadata.xml` вручную: любые изменения
  вносите только через команду `--write-verification-metadata`.
- При необходимости полной очистки окружения остановите демоны Gradle
  (`./gradlew --stop`) и удалите каталоги `.gradle/` и `~/.gradle/caches`.
