services:
  db:
    image: postgres:18.0
    container_name: user_service_db
    restart: unless-stopped
    stop_grace_period: 60s
    environment:
      POSTGRES_DB: user_service
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      TZ: UTC
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d user_service -h 127.0.0.1 -t 5"]
      start_period: 120s
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak-db:
    image: postgres:18.0
    container_name: keycloak_db
    restart: unless-stopped
    stop_grace_period: 60s
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      TZ: UTC
    volumes:
      - keycloak_db_data:/var/lib/postgresql
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d keycloak -h 127.0.0.1 -t 5"]
      start_period: 120s
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:26.4.2
    container_name: keycloak
    restart: unless-stopped
    stop_grace_period: 60s
    depends_on:
      keycloak-db:
        condition: service_healthy
    command: ["start"]
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: password
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak-db
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: user
      KC_DB_PASSWORD: password
      KC_HOSTNAME: "localhost"
      KC_HOSTNAME_PORT: "9090"
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_HEALTH_ENABLED: "true"
      TZ: UTC
    ports:
      - "127.0.0.1:9090:8080"
    volumes:
      - keycloak_data:/opt/keycloak/data
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/127.0.0.1/9000; printf \"HEAD /health/ready HTTP/1.0\\r\\n\\r\\n\" >&3; head -n1 <&3 | grep -q \" 200 \"'"]
      start_period: 120s
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:8.2.3-alpine
    container_name: redis
    restart: unless-stopped
    stop_grace_period: 30s
    environment:
      TZ: UTC
    command: ["redis-server", "--appendonly", "yes", "--appendfsync", "everysec"]
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 -p 6379 ping | grep -q PONG"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: bitnamilegacy/kafka:4.0.0-debian-12-r10
    container_name: kafka
    restart: unless-stopped
    stop_grace_period: 300s
    environment:
      KAFKA_CFG_NODE_ID: "1"
      KAFKA_CFG_PROCESS_ROLES: "broker,controller"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT"
      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,EXTERNAL://:19092,CONTROLLER://:9093"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094"
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      TZ: UTC
    ports:
      - "127.0.0.1:9094:19092"
    volumes:
      - kafka_data:/bitnami/kafka
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server 127.0.0.1:9092 >/dev/null 2>&1 || exit 1"]
      start_period: 120s
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: minio
    restart: unless-stopped
    stop_grace_period: 45s
    environment:
      MINIO_ROOT_USER: user
      MINIO_ROOT_PASSWORD: password
      TZ: UTC
    command: ["server", "/data", "--console-address", ":9001"]
    ports:
      - "127.0.0.1:9000:9000"
      - "127.0.0.1:9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "wget -T 2 -qO- http://127.0.0.1:9000/minio/health/live >/dev/null || curl -fsS --connect-timeout 2 --max-time 4 http://127.0.0.1:9000/minio/health/live >/dev/null || exit 1"]
      start_period: 25s
      interval: 10s
      timeout: 5s
      retries: 5

  mc:
    image: minio/mc:RELEASE.2025-08-13T08-35-41Z
    container_name: minio_client
    restart: "no"
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - app_network
    entrypoint:
      - /bin/sh
      - -c
      - |
          set -eu
          ALIAS="local"
          ENDPOINT="http://minio:9000"
          USERNAME="user"
          PASSWORD="password"
          BUCKET="corpbucket"
          POLICY="private"

          i=0
          until /usr/bin/mc alias set "$$ALIAS" "$$ENDPOINT" "$$USERNAME" "$$PASSWORD"; do
            i=$$((i+1))
            [ "$$i" -ge 120 ] && echo "mc: timeout waiting for minio" >&2 && exit 1
            echo 'mc: waiting for minio...'
            sleep 2
          done

          /usr/bin/mc mb -p "$$ALIAS/$$BUCKET" || true

          case "$$POLICY" in
            public|download) /usr/bin/mc anonymous set download "$$ALIAS/$$BUCKET" || true ;;
            private|none|"") /usr/bin/mc anonymous set none "$$ALIAS/$$BUCKET" || true ;;
          esac

          echo "MinIO bucket $$BUCKET policy=$$POLICY"

volumes:
  postgres_data:
  keycloak_db_data:
  keycloak_data:
  redis_data:
  kafka_data:
  minio_data:

networks:
  app_network:
    driver: bridge
